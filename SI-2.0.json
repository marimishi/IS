{
  "name": "SI-2.0",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -2608,
        -48
      ],
      "id": "e8aefcd3-a5fc-4437-b41d-4f127ec11f88",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "jsCode": "const results = [];\nlet page = 0;\nconst size = 100;\n\nwhile (true) {\n  const url = `http://212.237.219.35:8080/students/14/cms/spares?page=${page}&size=${size}`;\n\n  try {\n    const response = await this.helpers.httpRequest({\n      method: \"GET\",\n      url,\n      json: true,\n      timeout: 30000\n    });\n\n    if (!response || response.length === 0) {\n      break;\n    }\n\n    for (const item of response) {\n      results.push({ json: item });\n    }\n\n    page += 1;\n    if (page > 100) {\n      break;\n    }\n    \n  } catch (error) {\n    throw error; \n  }\n}\n\nconsole.log(`Получено ${results.length} записей из CMS`);\nreturn results;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2160,
        -48
      ],
      "id": "20989888-db9e-4401-a21a-c796f80ecb40",
      "name": "Fetch All From CMS"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst processedItems = [];\n\nfor (const item of items) {\n  try {\n    const json = item.json;\n\n    const spareCode = json.spareCode || json.spare_code || json.code || '';\n    const spareName = json.spareName || json.spare_name || json.name || '';\n    const spareDescription = json.spareDescription || json.spare_description || json.description || '';\n    const spareType = json.spareType || json.spare_type || json.type || '';\n    const spareStatus = json.spareStatus || json.spare_status || json.status || '';\n    const price = json.price || 0;\n    const quantity = json.quantity || 0;\n    const updatedAt = json.updatedAt || json.updated_at || new Date().toISOString();\n\n    if (!spareCode || !spareName) {\n      continue;\n    }\n\n    processedItems.push({\n      spare_code: String(spareCode),\n      spare_name: String(spareName),\n      spare_description: String(spareDescription || ''),\n      spare_type: String(spareType || ''),\n      spare_status: String(spareStatus || ''),\n      price: Number(price),\n      quantity: Number(quantity),\n      updated_at: updatedAt,\n      is_active: true,\n      last_sync_at: new Date().toISOString()\n    });\n  } catch (error) {\n  }\n}\n\nreturn processedItems.map(item => ({ json: item }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1920,
        -48
      ],
      "id": "f9247f91-68f2-42c3-8b17-bc2b023208d0",
      "name": "Process CMS Data",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE spare_parts \nSET is_active = false, \n    last_sync_at = NOW() \nWHERE is_active = true;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2384,
        -48
      ],
      "id": "e4f1ef65-fd8a-4ee5-90ab-954c4cfbb6da",
      "name": "Mark All Inactive",
      "credentials": {
        "postgres": {
          "id": "Vo8LadIRr01jrhNm",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "spare_parts",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "spare_code": "={{ $json.spare_code }}",
            "spare_name": "={{ $json.spare_name }}",
            "spare_description": "={{ $json.spare_description }}",
            "spare_type": "={{ $json.spare_type }}",
            "spare_status": "={{ $json.spare_status }}",
            "price": "={{ $json.price }}",
            "quantity": "={{ $json.quantity }}",
            "updated_at": "={{ $json.updated_at }}",
            "is_active": "={{ $json.is_active }}",
            "last_sync_at": "={{ $json.last_sync_at }}"
          },
          "matchingColumns": [
            "spare_code"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "spare_code",
              "displayName": "spare_code",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "spare_name",
              "displayName": "spare_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "spare_description",
              "displayName": "spare_description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "spare_type",
              "displayName": "spare_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "spare_status",
              "displayName": "spare_status",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "price",
              "displayName": "price",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "quantity",
              "displayName": "quantity",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "last_sync_at",
              "displayName": "last_sync_at",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1696,
        -48
      ],
      "id": "226dc235-6c95-4bdd-99fa-ce865130f99f",
      "name": "Upsert Active Parts",
      "credentials": {
        "postgres": {
          "id": "Vo8LadIRr01jrhNm",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    spare_code,\n    spare_name,\n    spare_description,\n    spare_type,\n    spare_status,\n    price,\n    quantity,\n    updated_at\nFROM spare_parts \nWHERE is_active = true\nORDER BY spare_code;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2336,
        192
      ],
      "id": "c0aa5f0e-5362-4025-8006-b78fcfa9d8f7",
      "name": "Get Active Parts For CSV",
      "credentials": {
        "postgres": {
          "id": "Vo8LadIRr01jrhNm",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nif (items.length === 0) {\n  return [{ json: { csv: '' } }];\n}\n\nconst rows = items.map(i => {\n  const json = i.json;\n  return [\n    json.spare_code || '',\n    json.spare_name || '',\n    json.spare_description || '',\n    json.spare_type || '',\n    json.spare_status || '',\n    Number(json.price || 0).toString(),\n    Number(json.quantity || 0).toString(),\n    json.updated_at || new Date().toISOString()\n  ].map(field => {\n    const strField = String(field);\n    if (strField.includes(';') || strField.includes('\"') || strField.includes('\\n')) {\n      return `\"${strField.replace(/\"/g, '\"\"')}\"`;\n    }\n    return strField;\n  }).join(\";\");\n});\n\nconst csvContent = rows.join(\"\\n\") + \"\\n\";\n\nreturn [{ json: { csv: csvContent } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2064,
        192
      ],
      "id": "3b0cd1cf-b0af-4c26-b52a-2b4d748e71d8",
      "name": "Build CSV With Header"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://212.237.219.35:8080/students/14/report/csv",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "text/csv; charset=utf-8",
        "body": "={{ $json.csv }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1824,
        192
      ],
      "id": "465eab3a-dd4b-46f9-a7d3-ecc5d266e878",
      "name": "Send CSV to Report API"
    },
    {
      "parameters": {
        "content": "### Поток данных №1\n\nинтеграционное приложение, вызывает CMS по API и получает набор данных (внимание, может быть пагинация). Далее интеграционное приложение сравнивает полученный набор, с данными в БД для хранения исторических данных. Записи в БД добавляются и обновляются.\n",
        "height": 304
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2912,
        -208
      ],
      "typeVersion": 1,
      "id": "9fb9a7c7-706a-4973-8dcb-deae5e59d37e",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "### Поток данных №2\n\nинтеграционное приложение, на основе данных в БД хранения исторических данных, формирует файл CSV. Данный файл отправляется в Report API. Особое внимание требуется уделить формату csv файла. Файл должен быть в кодировке UTF-8, а разделяющий символ для csv - \";\"",
        "height": 288
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2912,
        144
      ],
      "typeVersion": 1,
      "id": "b6e069e5-2859-4b17-8f76-0c847864ae57",
      "name": "Sticky Note3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -2592,
        192
      ],
      "id": "6b9638ad-86a7-43f3-a320-a9a9a9712c49",
      "name": "When clicking ‘Execute workflow’"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Mark All Inactive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch All From CMS": {
      "main": [
        [
          {
            "node": "Process CMS Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process CMS Data": {
      "main": [
        [
          {
            "node": "Upsert Active Parts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark All Inactive": {
      "main": [
        [
          {
            "node": "Fetch All From CMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Active Parts": {
      "main": [
        []
      ]
    },
    "Get Active Parts For CSV": {
      "main": [
        [
          {
            "node": "Build CSV With Header",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build CSV With Header": {
      "main": [
        [
          {
            "node": "Send CSV to Report API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Get Active Parts For CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Yekaterinburg",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "c3697ead-fc0e-4430-b7d1-7eab7a9807ba",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f87382886a5d843c66093e8118775bd21ce456b80ee5ff4a248b76685a90346f"
  },
  "id": "X8wmJ2S7IBT5RPMD",
  "tags": []
}