# Интеграционное приложение SI-2.0

Этот проект представляет собой автоматизированный workflow в n8n для синхронизации данных о запасных частях между CMS и PostgreSQL базой данных с последующей отправкой отчёта в формате CSV.

Авторы: Мишина Мария и Кондренко Дарья
## Описание

Приложение состоит из двух независимых потоков данных:

1. **Поток №1**: Запускается по расписанию, загружает данные из CMS, обрабатывает их и сохраняет в базу данных PostgreSQL.
2. **Поток №2**: Запускается вручную, формирует CSV-файл на основе всех записей в БД и отправляет его в Report API.

## Архитектура

### Основные узлы (nodes)

1. **Schedule Trigger** — триггер по расписанию (каждый час).
2. **HTTP REQUEST** — загрузка данных из CMS с поддержкой пагинации.
3. **Process CMS Data** — валидация и преобразование данных.
4. **Mark All Inactive** — помечает все записи в БД как неактивные перед обновлением.
5. **Upsert Active Parts** — обновление или добавление активных записей в таблицу `spare_parts`.
6. **Get Active Parts For CSV** — выборка активных записей из БД.
7. **Build CSV With Header** — формирование CSV-файла с разделителем `;`.
8. **Send CSV to Report API** — отправка CSV в Report API.

### Таблица базы данных spare_parts

| Поле               | Описание                     |
|---------------------|------------------------------|
| id                  | Первичный ключ               |
| spare_code          | Код детали                   |
| spare_name          | Название детали              |
| spare_description   | Описание                     |
| spare_type          | Тип детали                   |
| spare_status        | Статус                       |
| price               | Цена                         |
| quantity            | Количество                   |
| updated_at          | Дата обновления в CMS        |
| is_active           | Активна ли запись            |
| last_sync_at        | Дата последней синхронизации |


## Использование

### Автоматическая синхронизация (Поток №1)

Workflow автоматически запускается каждый час. При запуске:

1. Все существующие активные записи в БД помечаются как неактивные
2. Загружаются все данные из CMS (с пагинацией)
3. Данные валидируются и преобразуются
4. Активные записи добавляются или обновляются в БД

### Ручная генерация отчёта (Поток №2)

Для формирования CSV-отчёта:

1. Откройте workflow в n8n
2. Нажмите кнопку "Execute workflow" на узле "When clicking ‘Execute workflow’"
3. Workflow:
   - Выберет все записи из БД
   - Сформирует CSV-файл с разделителем `;`
   - Отправит файл в Report API

## Формат CSV-файла

- Кодировка: UTF-8
- Разделитель: `;`
- Поля в порядке:
  1. spare_code
  2. spare_name
  3. spare_description
  4. spare_type
  5. spare_status
  6. price
  7. quantity
  8. updated_at

## Обработка ошибок

- При ошибке загрузки данных из CMS workflow прерывается
- Некорректные записи (без spare_code или spare_name) пропускаются с предупреждением
- Ошибки обработки отдельных записей логируются, но не прерывают весь процесс

## Технические особенности

- **Пагинация CMS**: автоматическая загрузка всех страниц
- **Контроль активности**: механизм `is_active` для отслеживания актуальных записей
- **Временные метки**: `last_sync_at` обновляется при каждой синхронизации
- **Экранирование CSV**: автоматическое экранирование полей с `;`, `"` и переносами строк

![Диаграмма workflows](https://raw.githubusercontent.com/marimishi/IS/refs/heads/main/docs/workflows.png)
