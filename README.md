# Интеграционное приложение SI-2.0

Этот проект представляет собой автоматизированный workflow в n8n для синхронизации данных о запасных частях между CMS и PostgreSQL базой данных с последующей отправкой отчёта в формате CSV.

Авторы: Мишина Мария и Кондренко Дарья
## Описание

Приложение состоит из двух независимых потоков данных:

1. **Поток №1**: Запускается по расписанию, загружает данные из CMS, обрабатывает их и сохраняет в базу данных PostgreSQL.
2. **Поток №2**: Запускается вручную, формирует CSV-файл на основе активных записей в БД и отправляет его в Report API.

## Архитектура

### Основные узлы (nodes)

1. **Schedule Trigger** — триггер по расписанию (каждый час).
2. **Fetch All From CMS** — загрузка данных из CMS с поддержкой пагинации.
3. **Process CMS Data** — валидация и преобразование данных.
4. **Mark All Inactive** — помечает все записи в БД как неактивные перед обновлением.
5. **Upsert Active Parts** — обновление или добавление активных записей в таблицу `spare_parts`.
6. **Get Active Parts For CSV** — выборка активных записей из БД.
7. **Build CSV With Header** — формирование CSV-файла с разделителем `;`.
8. **Send CSV to Report API** — отправка CSV в Report API.

### Таблица базы данных spare_parts

| Поле               | Тип       | Обязательное | Описание                     |
|---------------------|-----------|--------------|------------------------------|
| id                  | serial    | Да           | Первичный ключ               |
| spare_code          | varchar   | Да           | Код детали                   |
| spare_name          | varchar   | Да           | Название детали              |
| spare_description   | text      | Нет          | Описание                     |
| spare_type          | varchar   | Да           | Тип детали                   |
| spare_status        | varchar   | Да           | Статус                       |
| price               | numeric   | Да           | Цена                         |
| quantity            | integer   | Да           | Количество                   |
| updated_at          | timestamp | Да           | Дата обновления в CMS        |
| is_active           | boolean   | Да           | Активна ли запись            |
| last_sync_at        | timestamp | Да           | Дата последней синхронизации |
| created_at          | timestamp | Нет          | Дата создания записи         |

## Установка и настройка

### Предварительные требования

- Установленный и запущенный n8n
- Доступ к PostgreSQL базе данных
- Доступ к CMS API (`http://212.237.219.35:8080`)
- Доступ к Report API (`http://212.237.219.35:8080`)

### Шаги установки

1. Импортируйте файл `SI-2.0.json` в n8n через меню "Import from file".
2. Настройте credentials для PostgreSQL:
   - Перейдите в Credentials → Add Credential → PostgreSQL
   - Введите параметры подключения к вашей базе данных
   - Присвойте имя "Postgres account"
3. Проверьте настройки узлов:
   - В узле "Fetch All From CMS" убедитесь, что URL CMS корректный
   - В узле "Send CSV to Report API" проверьте URL для отправки CSV
4. Активируйте workflow в настройках.

## Использование

### Автоматическая синхронизация (Поток №1)

Workflow автоматически запускается каждый час. При запуске:

1. Все существующие записи в БД помечаются как неактивные
2. Загружаются все данные из CMS (с пагинацией)
3. Данные валидируются и преобразуются
4. Активные записи добавляются или обновляются в БД

### Ручная генерация отчёта (Поток №2)

Для формирования CSV-отчёта:

1. Откройте workflow в n8n
2. Нажмите кнопку "Execute workflow" на узле "When clicking ‘Execute workflow’"
3. Workflow:
   - Выберет все активные записи из БД
   - Сформирует CSV-файл с разделителем `;`
   - Отправит файл в Report API

## Формат CSV-файла

- Кодировка: UTF-8
- Разделитель: `;`
- Поля в порядке:
  1. spare_code
  2. spare_name
  3. spare_description
  4. spare_type
  5. spare_status
  6. price
  7. quantity
  8. updated_at

## Логирование и отладка

- Все узлы содержат консольный вывод через `console.log()` и `console.error()`
- Ключевые этапы логируются:
  - Количество полученных записей из CMS
  - Количество обработанных записей
  - Предупреждения о некорректных данных

## Обработка ошибок

- При ошибке загрузки данных из CMS workflow прерывается
- Некорректные записи (без spare_code или spare_name) пропускаются с предупреждением
- Ошибки обработки отдельных записей логируются, но не прерывают весь процесс

## Технические особенности

- **Пагинация CMS**: автоматическая загрузка всех страниц (максимум 100 страниц)
- **Контроль активности**: механизм `is_active` для отслеживания актуальных записей
- **Временные метки**: `last_sync_at` обновляется при каждой синхронизации
- **Экранирование CSV**: автоматическое экранирование полей с `;`, `"` и переносами строк
